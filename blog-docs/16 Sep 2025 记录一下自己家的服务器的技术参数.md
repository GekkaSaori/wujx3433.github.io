---
layout: doc
---

# 16 Sep 2025 记录一下自己家的服务器的技术参数

![](/16 Sep 2025.png)

## 硬件配置

- AMD Ryzen 5 5600G（懒得配亮机卡，现在看起来没什么性价比）
- Colorful 16G 2666 DDR4 RAM x4（超到了 3000 MT/s）
- ASUS PRIME X570-PRO
- CoolerMaster GX750W（80PLUS 金牌认证，全模组）
- HBA 卡 LSI 9300-16i（应该换成 9400-8i）
- 网卡 Mellanox ConnectX-4 Lx
- 网卡 Realtek RTL8125 2.5GbE
- 系统盘 Fanxiang S500PRO 1TB
- 阵列缓存盘 Intel P4510 1TB
- 游戏数据盘 Intel P4511 1000G
- Timeshift 备份盘 WDC WD5000LPCX
- Apple TimeMachine 备份盘 ST4000DM004
- 磁盘阵列 HGST 8TB x6（洋垃圾…？）

## Infrastructure

我们想要的：
- 能支持跑满万兆网络的软硬件性能；
- 相对意义上的高可用和容灾；
- 便利的访问（虽然现在没有外网访问的需求，但要方便未来引入）；
- 良好的兼容性（各种终端设备软硬件和操作系统差异大，Android/iOS/Windows/macOS/Linux 都能用）。

整个基础设施主要需要讨论的是磁盘阵列的架构。我们选择 RAID-6 的原因主要有以下几点：
- 相对意义上的高可用，即使挂一两块盘还能工作（特别是因为磁盘阵列的成员盘都是洋垃圾，并且暂时还没有热备盘）；
- 对 RAID-5 重建可靠性不确定性（ref BZOJ offline event）的忧虑（Uncorrectable Read Error Rate）；
- 也许不怎么需要高性能（磁盘性能差一点也无所谓，有钱的话谁不选择组全闪阵列，配个固态当缓存让数据别那么难看就行了）。

为了满足万兆网络传输，阵列的写入速度应当在 1GiB/s 以上。考虑到磁盘阵列主要的使用场景是以一次性顺序写入大量数据，之后顺序
读取，而 6 块机械硬盘组成的 RAID-6 的写入速度远远低于需要的速度，使用 SSD 做写入缓存就变得必要起来。

常见的家用 NAS 磁盘阵列基础设施架构有：
- Btrfs：群晖等商用解决方案使用的文件系统，在文件系统层级上支持 RAID 及现代化文件系统应支持的功能（快照、透明压缩和
 checksum 等）。但 Btrfs 的 RAID-6 支持在几年间仍然处于实验阶段，无法用于生产环境[1](#references)。
- ZFS：是与 Btrfs 类似的现代化文件系统，由于许可问题不包含在 kernel tree 中。原生支持 checksum 和 RAID 等功能，
 但不支持 write cache，ZIL 和 L2ARC 也不是我们希望的严格意义上的“缓存”或无法用于写入环境。
- LVM：是在内核 device-mapper 层面实现了逻辑卷管理。有部分快照和 RAID 等现代文件系统应有的功能，但基于块设备而非基于
 文件，但显然没有 CoW 这种令人兴奋的功能。
- mdadm：see below.

最初的时候我们使用的是 mdadm 管理的 RAID，为实现缓存，在 mdadm 上套了一层 Bcache。在虚拟机中测试在一些 corner 
cases 下 mdadm 管理的 RAID 无法从 fail 中恢复。我们也不希望技术栈过于复杂（如 mdadm + LVM + Btrfs），因此我们
将 RAID 迁移到了 LVM 管理的 RAID-6。

最终我们为磁盘阵列选定的的方案为 lvm-raid + lvm-writecache + ext4. 这在 SMB 与 WebDAV 的性能已经足够令人满意。

![](/speed-example.jpeg)

文件共享方面我们使用的是 SMB、WebDAV 和 iSCSI。iSCSI 用于为 Steam 读写游戏数据文件提供更好的性能（总不能让 Steam 
也跑在“网络驱动器”上吧），WebDAV 几乎是 Infuse 专用的，不知道为什么 Infuse 的 SMB 性能令人意外的差，WebDAV 就没有
这种问题，跑一个 AList 或者 OpenList 凑合用着吧（那会儿 AList 还没被卖掉）。

## 要修的锅

1. 2022 年的时候卸载了 Wayland，只留下了 X11，结果 2025 年 X11 已经没人维护也基本没人在用了。现在也基本没什么办法
 再装回去了，有一堆包要升级却只能 hold，要解决只能重装的时候再说。
2. LVM 开机自动挂载有问题。LiveCD 之类的系统能自动识别并挂载，本机系统死活挂不上，写了个 systemd service 在挂 fstab
 之前先识别并挂载 LVM 卷。这种解决方案太 dirty，得换个方案。
3. lvm-raid 的性能令人意外地差。六盘 RAID-6 写入速度只有 100-200MiB/s，如果不是有缓存的话性能实在是没法看。
4. 功耗和发热问题。LSI 9300-16i 是最初错误估计需求购买的，发热和功耗高得一塌糊涂，以后必须要换掉。
5. 系统需要精简。整个系统现在有接近 4000 个包，一个能正常工作的系统不需要这么多包。

## References

[1. RAID56 STATUS AND RECOMMENDED PRACTICES](https://btrfs.readthedocs.io/en/latest/btrfs-man5.html#raid56-status-and-recommended-practices)

## 每日福音

He stepped forward and touched the coffin; at this the bearers halted, and he said, “Young man, I tell you, arise!”

--Luke 7:14 USCCB

遂上前按住棺材，抬棺材的人就站住了。青年人，我对你说：起来吧！

--路加福音 7:14 思高

## Credits

作者：[GekkaSaori](https://github.com/GekkaSaori)

## Special Thanks

Mc'Flurry, for lots of furrrrrs and purrrrrs.

ZnP, for her accompanying, mental supports, and lots of love ❤️.
